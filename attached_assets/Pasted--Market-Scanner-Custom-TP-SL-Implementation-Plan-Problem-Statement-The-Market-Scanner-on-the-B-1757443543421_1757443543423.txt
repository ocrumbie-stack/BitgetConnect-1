
# Market Scanner Custom TP/SL Implementation Plan

## Problem Statement
The Market Scanner on the Bots page currently uses preset TP/SL values calculated by `calculateOptimalTradeSetup()`. Users want to input their own TP/SL values as actual pair percentage changes (not leverage-adjusted).

## Research Findings

### Key Files Identified:
1. **`client/src/pages/bot.tsx`** (lines 2800-3100) - Scanner UI configuration
2. **`server/routes.ts`** (lines 1200-1300, 6500-6600) - Auto scanner deployment & TP/SL logic
3. **`server/storage.ts`** - Data persistence

### Current Flow:
1. User configures scanner (capital, leverage, max bots)
2. Backend calls `calculateOptimalTradeSetup(leverage, 'auto_scanner')`
3. Returns preset values: 2-3% SL, 4-6% TP (pair percentage moves)
4. Deploys bots with calculated values

### Issues Found:
- No UI inputs for custom TP/SL
- Auto scanner bypasses user TP/SL preferences
- Backend hardcoded to use `calculateOptimalTradeSetup()`

## Implementation Plan

### Phase 1: Frontend UI Changes
**File: `client/src/pages/bot.tsx`**

1. **Add State Variables** (around line 100):
   ```typescript
   const [scannerStopLoss, setScannerStopLoss] = useState('3.0');
   const [scannerTakeProfit, setScannerTakeProfit] = useState('6.0');
   const [useCustomTPSL, setUseCustomTPSL] = useState(false);
   ```

2. **Add UI Input Fields** (around line 2900 in Scanner Configuration Card):
   ```typescript
   {/* Custom TP/SL Toggle */}
   <div className="space-y-3">
     <div className="flex items-center space-x-2">
       <Switch 
         checked={useCustomTPSL}
         onCheckedChange={setUseCustomTPSL}
       />
       <Label>Use Custom TP/SL</Label>
     </div>
     
     {useCustomTPSL && (
       <div className="grid grid-cols-2 gap-4">
         <div className="space-y-2">
           <Label>Stop Loss (%)</Label>
           <Input
             type="number"
             step="0.1"
             value={scannerStopLoss}
             onChange={(e) => setScannerStopLoss(e.target.value)}
             placeholder="3.0"
           />
         </div>
         <div className="space-y-2">
           <Label>Take Profit (%)</Label>
           <Input
             type="number" 
             step="0.1"
             value={scannerTakeProfit}
             onChange={(e) => setScannerTakeProfit(e.target.value)}
             placeholder="6.0"
           />
         </div>
       </div>
     )}
   </div>
   ```

3. **Update Scanner Request** (around line 3000):
   ```typescript
   const scannerData = {
     userId: 'default-user',
     maxBots: parseInt(scannerMaxBots),
     minConfidence: minConfidence,
     tradingStyle: tradingStyle,
     customTPSL: useCustomTPSL ? {
       stopLoss: parseFloat(scannerStopLoss),
       takeProfit: parseFloat(scannerTakeProfit)
     } : null
   };
   ```

### Phase 2: Backend API Changes
**File: `server/routes.ts`**

1. **Update Auto Scanner Scan Endpoint** (around line 1200):
   ```typescript
   app.post('/api/auto-scanner/scan', async (req, res) => {
     const { userId, maxBots, minConfidence, tradingStyle, customTPSL } = req.body;
     
     // Store custom TP/SL in scan results for later deployment
     const scanResults = {
       opportunities: opportunities,
       customTPSL: customTPSL || null,
       // ... other properties
     };
   });
   ```

2. **Update Auto Scanner Deploy Endpoint** (around line 1250):
   ```typescript
   app.post('/api/auto-scanner/deploy', async (req, res) => {
     const { opportunities, customTPSL } = req.body;
     
     for (const opportunity of opportunities) {
       // Use custom TP/SL if provided, otherwise calculate
       let finalStopLoss, finalTakeProfit;
       
       if (customTPSL) {
         finalStopLoss = customTPSL.stopLoss;
         finalTakeProfit = customTPSL.takeProfit;
         console.log(`ðŸŽ¯ Using CUSTOM TP/SL: ${finalStopLoss}% SL, ${finalTakeProfit}% TP`);
       } else {
         const tradeSetup = calculateOptimalTradeSetup(leverage, 'auto_scanner');
         finalStopLoss = tradeSetup.stopLoss;
         finalTakeProfit = tradeSetup.takeProfit;
         console.log(`ðŸŽ¯ Using CALCULATED TP/SL: ${finalStopLoss}% SL, ${finalTakeProfit}% TP`);
       }
       
       // Store in bot execution with custom values
       const executionData = {
         // ... existing properties
         customStopLoss: finalStopLoss,
         customTakeProfit: finalTakeProfit,
         exitCriteria: {
           stopLoss: -Math.abs(finalStopLoss),
           takeProfit: Math.abs(finalTakeProfit),
           maxRuntime: 240,
           exitStrategy: 'auto_scanner_custom'
         }
       };
     }
   });
   ```

3. **Update Bot Execution Monitoring** (around line 2800):
   ```typescript
   // In the bot monitoring loop, use custom TP/SL if available
   if (deployedBot.customStopLoss && deployedBot.customTakeProfit) {
     finalExitCriteria = {
       stopLoss: -Math.abs(deployedBot.customStopLoss),
       takeProfit: Math.abs(deployedBot.customTakeProfit),
       maxRuntime: 240,
       exitStrategy: 'custom_user_tpsl'
     };
     console.log(`ðŸ“Š Using CUSTOM user TP/SL: ${deployedBot.customStopLoss}% SL, ${deployedBot.customTakeProfit}% TP`);
   }
   ```

### Phase 3: Data Schema Updates
**File: `server/storage.ts`**

1. **Update Bot Execution Storage** (around line 200):
   ```typescript
   async storeBotExecution(execution: any): Promise<string> {
     const botExecution = {
       // ... existing fields
       customStopLoss: execution.customStopLoss || null,
       customTakeProfit: execution.customTakeProfit || null,
       // ... other fields
     };
   }
   ```

### Phase 4: UI Enhancement for Deployment Results
**File: `client/src/pages/bot.tsx`**

1. **Update Deployment Success Message** (around line 3050):
   ```typescript
   onSuccess: (results) => {
     const tpslInfo = useCustomTPSL 
       ? `Custom TP/SL: ${scannerStopLoss}% SL, ${scannerTakeProfit}% TP`
       : 'Auto-calculated TP/SL';
       
     toast({
       title: "Bots Deployed Successfully! ðŸ¤–",
       description: `Deployed ${results.deployedBots} AI bots with $${results.capitalPerBot} each. ${tpslInfo}`,
     });
   }
   ```

## Technical Notes

### TP/SL Implementation Details:
- Values are stored as **pair percentage moves** (e.g., 3% means 3% price change of the trading pair)
- No leverage multiplication applied to user inputs
- Backend converts to negative for stop loss: `stopLoss: -Math.abs(userInput)`
- Positive values for take profit: `takeProfit: Math.abs(userInput)`

### Validation Rules:
- Stop Loss: 0.5% - 10% (reasonable range for pair moves)
- Take Profit: 1% - 20% (reasonable range for pair moves) 
- Risk/Reward ratio warning if TP < SL

### Backward Compatibility:
- Existing auto scanner functionality preserved when custom TP/SL is disabled
- Default toggle state: OFF (uses calculated values)
- Existing deployed bots continue using their original TP/SL

## Testing Plan

### Test Cases:
1. **Default Behavior**: Verify existing auto scanner works without custom TP/SL
2. **Custom Values**: Deploy with 2% SL, 4% TP and verify bot execution
3. **Validation**: Test edge cases (negative values, extreme ranges)
4. **Mixed Deployment**: Some bots with custom, some with auto TP/SL
5. **UI State**: Toggle behavior and form validation

### Expected Results:
- Scanner results display custom TP/SL info
- Deployed bots use exact user-specified percentages
- Bot monitoring respects custom values
- Console logs show "CUSTOM" vs "CALCULATED" TP/SL usage

## Implementation Priority:
1. **High**: Frontend UI inputs (Phase 1)
2. **High**: Backend API integration (Phase 2) 
3. **Medium**: Data persistence (Phase 3)
4. **Low**: UI enhancements (Phase 4)

## Risk Assessment:
- **Low Risk**: Changes are additive, existing functionality preserved
- **No Breaking Changes**: Custom TP/SL is optional feature
- **Clear Rollback**: Toggle can be disabled to revert to original behavior

This plan provides complete control over TP/SL values while maintaining the existing auto-calculation as fallback.
